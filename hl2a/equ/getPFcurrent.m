function [Iex,Ip,betap]=getPFcurrent(varargin)
%%
%       This program set the external PF current
%       Developed by Song xianming 2013.11.16
% shape configuration=varargin{1};

%% HL2A
% OH   1
% VF   2
% RF   3
% MP1U  4
% MP2U  5
% MP3U  6
% MCU  7
% MP1L  8
% MP2L  9
% MP3L  10
% MCL  11






%% shot:20994-limiter; 20985-divertor
t0=0;
t1=1500;
shotnum=20994;

[yPFs,tPF]=hl2adb(shotnum,{'Ioh' 'Iv' 'Ir' 'Imp1_3' 'Imp2_mc'},t0,t1,1,'mmd');
[betap,tBeta]=hl2adb(shotnum,{'Beta_p'},t0,t1,1,'emd');
[Ip,tIp]=hl2adb(shotnum,{'FEx_Ip'},t0,t1,1,'fbc');




%% fit the experimental data
mySize=size(yPFs);
yPFs=smooth(yPFs,21,'moving');

yPFs=reshape(yPFs,mySize);
betap=smooth(betap,21,'moving');
Ip=smooth(Ip,21,'moving');

save(['d:\data\d' num2str(shotnum)],'yPFs','betap','Ip','tPF','tBeta','tIp')
load(['d:\data\d' num2str(shotnum)],'yPFs','betap','Ip','tPF','tBeta','tIp')








% the fitting time
tfit=1000;

indexPF=find(tfit==tPF);
Iex=[yPFs(indexPF,1) yPFs(indexPF,2) yPFs(indexPF,3) 0 0 0 0 yPFs(indexPF,4) yPFs(indexPF,5) yPFs(indexPF,4) yPFs(indexPF,5)]*1e3;
Ip=Ip(tfit==tIp)*1e3;
betap=betap(tfit==tBeta);













return

switch varargin{1}
    case 'SN'
%         shot 20000 t=600ms
%       Iex=[3.3129 16.703 0.061 0 0 0 0 12.123  13.747 12.123  13.747]*1.0e3;
%       Iex=[3.3129 13.703 0.061 0 0 0 0 12.123  13.747 12.123  13.747]*1.0e3;

       t=1000;
       shotnum=20985;
       [yIp,tt]=hl2adb(shotnum,'FEx_Ip',t,t+1,'1000hz','fbc');
       index=1;
       Ip=yIp(index)*1.0e3;
        [yPFs,tt]=hl2adb(shotnum,{'Ioh' 'Iv' 'Ir' 'Imp1_3' 'Imp2_mc'},t,t+1,'1000hz','mmd');
        Iex=[yPFs(index,1:3) 0 0 0 0 yPFs(index,4:5)  yPFs(index,4:5)]*1.0e3;
        save('c:\hl2a\data\equ\Iex20985','Iex','Ip')
        load('c:\hl2a\data\equ\Iex20985','Iex','Ip')
        
%         save('c:\hl2a\data\equ\Iex','Iex','Ip')
%         load('c:\hl2a\data\equ\Iex','Iex','Ip')
         
        
    case 'Limiter'
        %%  limiter
        
        
        % Iext244=[-50 -50 -1.0 -1.0 1.26 1.26 6.97 6.97 7.45 7.45 11.55 11.55 7.2 7.2 -28.65 -28.65 -11.76 -11.76]*1e3;
        
        %
         Iex=[-85 -85 0.155 0.155 3.095 3.095 9.855 9.855 10.34 10.34 11.65 11.65 6.56 6.56 -34.095 -34.095 -16.15 -16.15]*1e3; % t=3.0s limiter
        % Iex=[-110 -110 2.77 2.77 5.77 5.77 12.43 12.43 12.44 12.44 10.15 10.15 4.46 4.46 -34.77 -34.77 -16.4 -16.4]*1e3; % t=5.0s limiter
        
        
        
        
        
        
        % Iex=[54 54 -3.467 -3.467 -3.845 -3.845 -1.59 -1.59 -1.13 -1.13 11.1 11.1 9.5 9.5 -3.6 -3.6 -2.4 -2.4]*1.0e3; % 600kA t=0.76s
        % Iex=[10 10 -2.42 -2.42 -1.68 -1.68 2.05 2.03 2.5 2.5 11.25 11.25 8.6 8.6 -12.8 -12.8 -6.20 -6.20]*1.0e3; % 600kA t=0.76s
        
    case 'DN'
        %% double null 3MA t=3.0s
        Iex=[-80 -80 -3.355 -3.355 1.595 1.595 9.855 9.855 10.34 10.34 11.65 11.65 6.56 6.56 -36.35 -36.35 -15.15 -15.15]*1.0e3;
        
        
        
        %% reset the global data
        % Iex=[10 10 -5.618 -5.618 -3.18 -3.18 2.033 2.033 2.5 2.5 11.25 11.25 8.6 8.6 -13.3 -13.3 -6.78 -6.78]*1.0e3; % 3MA t=1.47s
        % return
end
        
        
        
        
        
        
        
        
        
        return
        
        
        
        %%  double null
        if nargin>0
            switch varargin{1}
                case 1
                    Iex=[110 110 -8.0 -8.0 -8.0 -8.0 -6.2 -6.2 -5.75 -5.75 10.9 10.9 10.8 10.8 4.573 4.573 1.161 1.161]*1.0e3;
                case 2
                    Iex=[-80 -80 -3.355 -3.355 1.595 1.595 9.855 9.855 10.34 10.34 11.65 11.65 6.56 6.56 -36.35 -36.35 -15.15 -15.15]*1.0e3;
                case 3
                    Iex=[-110 -110 -0.43 -0.43 4.27 4.27 12.43 12.43 12.44 12.44 10.15 10.15 4.46 4.46 -34.77 -34.77 -16.4 -16.4]*1.0e3;
                case 4
                    %             Iex=[110000,109999.999999925,11224.4897899700,11224.4897899700,11956.5217371664,11956.5217371664,12790.6976787374,12790.6976787374,13750.0000031464,13750.0000031464,42896.1448384282,42896.1448384282,16128.3508482998,16128.3508482998,8366.78254231249,8366.78254231248,2342.64638427848,2342.64638427848];
                    % % Z=0.9  chi=0.0065 phi=9.4863
                    Iex=[110000.000000000,110000.000000006,11224.4897968617,11224.4897968617,11956.5217383982,11956.5217383982,12790.6976742367,12790.6976742367,13749.9999999896,13749.9999999896,30421.9446815942,30421.9446815941,29195.7921536684,29195.7921536684,4901.12160872059,4901.12160872059,3264.16335534357,3264.16335534357];
                    % % Z=1.1  chi=0.0082 phi=9.49
                    Iex=[110000,110000.000000008,11224.4897972087,11224.4897972087,11956.5217382016,11956.5217382016,12790.6976740974,12790.6976740974,13749.9999999872,13749.9999999872,34352.6108164287,34352.6108164287,25730.4970274181,25730.4970274181,5543.12251743732,5543.12251743732,3144.88323873631,3144.88323873631];
                    % z=1.1  0.0119 phi=9.4587
                    % Iex=[1.1000    1.1000    0.1111    0.1111    0.1183    0.1183    0.1250    0.1250    0.1410    0.1410    0.3657    0.3657    0.2285    0.2285    0.0623    0.0623    0.0297    0.0297]*1e5;
                    Iex=[110000,110000.000000001,11111.1111117163,11111.1111117163,11827.9569884264,11827.9569884264,12500.0000000989,12500.0000000989,14102.5641026800,14102.5641026799,36567.1559043720,36567.1559043720,22852.6155920950,22852.6155920950,6231.98840234064,6231.98840234064,2969.16726887484,2969.16726887484];
                case 5
                    % % Z=1.4  4.4079e-07
                    %             Iex=[-41895.4274709596,-41895.4274632268,-5236.92852352350,-5236.92852352350,-3491.28559775018,-3491.28559775018,-2094.77130099429,-2094.77130099429,4189.54276932492,4189.54276932492,25359.4335422629,25359.4335422629,5817.75425066809,5817.75425066809,-33779.8739702115,-33779.8739702115,-16318.8904486161,-16318.8904486161];
                    
                    % Z=1.4  3.2452e-07
                    Iex=[-32589.1599780533,-32589.1599695261,-8147.29005665704,-8147.29005665705,-6517.83197104344,-6517.83197104344,-3621.01772069492,-3621.01772069492,8147.29001041849,8147.29001041849,12376.6068603216,12376.6068603216,10144.8155474863,10144.8155474863,-34183.8319284068,-34183.8319284068,-16136.3351412151,-16136.3351412151];
                    % Z=1.4  3.5189e-07
                    %           Iex=[-36092.5879783579,-36092.5879698030,-7218.51766388865,-7218.51766388865,-5156.08397221889,-5156.08397221889,-3609.25873864391,-3609.25873864391,9023.14701202015,9023.14701202015,13590.4678729436,13590.4678729435,9869.58915293484,9869.58915293484,-34153.3125119957,-34153.3125119957,-16160.6541612853,-16160.6541612853];
                    % 2.474328612302937e-07
                    %           Iex=[-36976.1569224478,-36976.1569195293,-7395.23142090881,-7395.23142090881,-5282.30811344030,-5282.30811344030,-3697.61566777596,-3697.61566777596,5282.30813668745,5282.30813668746,46343.1044233863,46343.1044233863,-9509.79186127987,-9509.79186127987,-33178.9295607088,-33178.9295607088,-15861.7274481438,-15861.7274481438];
                    % 2.4088e-07
                    %           Iex=[-37080.1570927443,-37080.1570897818,-7416.03145372814,-7416.03145372814,-5297.16528100952,-5297.16528100952,-3090.01306718602,-3090.01306718602,3708.01571408675,3708.01571408675,48191.8340539753,48191.8340539753,-10033.6527908927,-10033.6527908927,-33181.5978425329,-33181.5978425329,-15860.4004380539,-15860.4004380539];
                    % Z=1.4    3.4969e-07
                    % [-37499.7542603225,-37499.7542517311,-6818.13720592610,-6818.13720592610,-4999.96721009967,-4999.96721009967,-2499.98355850196,-2499.98355850196,7499.95086951309,7499.95086951308,16342.4928091635,16342.4928091635,8848.64686209310,8848.64686209310,-34064.5895145191,-34064.5895145190,-16185.6409292575,-16185.6409292575];            constraintMatrix(3,1)=-1/5.5;
                case 6
                    % % z=1.1  0.0119 phi=9.4587
                    Iex1=[110000,110000.000000001,11111.1111117163,11111.1111117163,11827.9569884264,11827.9569884264,12500.0000000989,12500.0000000989,14102.5641026800,14102.5641026799,36567.1559043720,36567.1559043720,22852.6155920950,22852.6155920950,6231.98840234064,6231.98840234064,2969.16726887484,2969.16726887484];
                    %             Iex1=[110000,109999.999999925,11224.4897899700,11224.4897899700,11956.5217371664,11956.5217371664,12790.6976787374,12790.6976787374,13750.0000031464,13750.0000031464,42896.1448384282,42896.1448384282,16128.3508482998,16128.3508482998,8366.78254231249,8366.78254231248,2342.64638427848,2342.64638427848];
                    %             Iex2=[-41895.4274709596,-41895.4274632268,-5236.92852352350,-5236.92852352350,-3491.28559775018,-3491.28559775018,-2094.77130099429,-2094.77130099429,4189.54276932492,4189.54276932492,25359.4335422629,25359.4335422629,5817.75425066809,5817.75425066809,-33779.8739702115,-33779.8739702115,-16318.8904486161,-16318.8904486161];
                    %             Iex2=[-32589.1599780533,-32589.1599695261,-8147.29005665704,-8147.29005665705,-6517.83197104344,-6517.83197104344,-3621.01772069492,-3621.01772069492,8147.29001041849,8147.29001041849,12376.6068603216,12376.6068603216,10144.8155474863,10144.8155474863,-34183.8319284068,-34183.8319284068,-16136.3351412151,-16136.3351412151];
                    Iex2=[-37499.7542603225,-37499.7542517311,-6818.13720592610,-6818.13720592610,-4999.96721009967,-4999.96721009967,-2499.98355850196,-2499.98355850196,7499.95086951309,7499.95086951308,16342.4928091635,16342.4928091635,8848.64686209310,8848.64686209310,-34064.5895145191,-34064.5895145190,-16185.6409292575,-16185.6409292575];
                    
                    I0=Iex1(1)+Iex2(1);
                    factor=I0/Iex1(1);
                    Iex=-factor*Iex1+Iex2;  %end point
                    %            Iex=[-110000,-109999.999992221,-12186.3746962734,-12186.3746962734,-10893.9565236038,-10893.9565236038,-10013.9076442543,-10013.9076442543,-4323.52879875317,-4323.52879875317,-1198.96288832760,-1198.96288832760,-4167.83156862140,-4167.83156862140,-38960.0207746445,-38960.0207746445,-17769.2989085069,-17769.2989085069];
                case 7
                    Iex1=[110000,109999.999999925,11224.4897899700,11224.4897899700,11956.5217371664,11956.5217371664,12790.6976787374,12790.6976787374,13750.0000031464,13750.0000031464,42896.1448384282,42896.1448384282,16128.3508482998,16128.3508482998,8366.78254231249,8366.78254231248,2342.64638427848,2342.64638427848];
                    Iex2=[-41895.4274709596,-41895.4274632268,-5236.92852352350,-5236.92852352350,-3491.28559775018,-3491.28559775018,-2094.77130099429,-2094.77130099429,4189.54276932492,4189.54276932492,25359.4335422629,25359.4335422629,5817.75425066809,5817.75425066809,-33779.8739702115,-33779.8739702115,-16318.8904486161,-16318.8904486161];
                    I0=Iex1(1)+Iex2(1);
                    factor=I0/Iex1(1);
                    Iex=-factor*Iex1+Iex2;
                    Iex=Iex1-Iex;
                otherwise
                    Iex=[110 110 -8.0 -8.0 -8.0 -8.0 -6.2 -6.2 -5.75 -5.75 10.9 10.9 10.8 10.8 4.573 4.573 1.161 1.161]*1.0e3;
                    Iex1=[-110 -110 -0.43 -0.43 4.27 4.27 12.43 12.43 12.44 12.44 10.15 10.15 4.46 4.46 -34.77 -34.77 -16.4 -16.4]*1.0e3;
                    Iex=Iex-Iex1;
            end
        else
            Iex=[-80 -80 -3.355 -3.355 1.595 1.595 9.855 9.855 10.34 10.34 11.65 11.65 6.56 6.56 -36.35 -36.35 -15.15 -15.15]*1.0e3;
        end
end

